<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#EAF6FF" />
  <link rel="manifest" href="manifest.json" />
  <title>Koala Ormanƒ±</title>
  <style>
    body { margin:0; font-family: -apple-system, system-ui, Arial; background:#EAF6FF; color:#0f172a; }
    .wrap { max-width: 520px; margin: 0 auto; padding: 16px; }
    .card { background:#fff; border-radius:16px; padding:16px; box-shadow: 0 6px 20px rgba(0,0,0,.06); }
    h1 { font-size: 22px; margin: 0 0 10px; }
    .sub { opacity:.75; margin: 0 0 14px; }

    .btn { width:100%; border:0; border-radius:14px; padding:14px; margin:10px 0; font-size:16px; font-weight:700; background:#1F6FEB; color:#fff; }
    .btn.secondary { background:#EAF2FF; color:#1F6FEB; }
    .btn.ghost { background:#F1F5F9; color:#0f172a; }

    .row { display:flex; gap:10px; flex-wrap:wrap; margin-top:14px; }
    .pill { background:#F1F5F9; padding:10px 12px; border-radius:999px; font-weight:700; }
    .koalas { font-size: 28px; letter-spacing: 2px; margin-top: 10px; }
    .toast { margin-top: 10px; font-weight: 700; min-height: 24px; }

    .hidden { display:none; }

    .topbar { display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .topbar .left { display:flex; gap:10px; flex-wrap:wrap; }
    .qcard { background:#fff; border-radius:16px; padding:16px; box-shadow: 0 6px 20px rgba(0,0,0,.06); margin-top:12px; }
    .q { font-size: 38px; font-weight: 900; text-align:center; margin: 6px 0 8px; }
    .hint { text-align:center; opacity:.75; margin:0 0 10px; }
    .ans { font-size: 28px; font-weight: 900; text-align:center; background:#F8FAFC; border-radius:14px; padding:12px; min-height: 38px; }

    .keypad { display:flex; flex-wrap:wrap; gap:10px; margin-top:12px; }
    .key { width: calc(33.333% - 6.666px); border:0; border-radius:14px; padding:14px 0; font-size:18px; font-weight:900; background:#fff; }
    .key.alt { background:#EAF2FF; color:#1F6FEB; }

    .pulse { animation: pulse 0.5s ease-in-out 2; }
    @keyframes pulse { 0% { transform: scale(1);} 50% { transform: scale(1.03);} 100% { transform: scale(1);} }
  </style>
</head>
<body>
  <div class="wrap">

    <!-- HOME -->
    <div class="card" id="home">
      <h1>Peri ve ƒ∞pek‚Äôin Koala Ormanƒ±</h1>
      <p class="sub">Bug√ºn 5 dakika. √úz√ºlmek yok. Koalalar b√ºy√ºr.</p>

      <button class="btn" onclick="startMode('speed')">Hƒ±z Turu</button>
      <button class="btn" onclick="startMode('target')">Hedef Turu</button>
      <button class="btn" onclick="startMode('boss')">Boss</button>

      <button class="btn secondary" onclick="showForest()">Ormana Bak üå≥</button>

      <div class="row">
        <div class="pill">‚≠ê Yƒ±ldƒ±z: <span id="stars">0</span></div>
        <div class="pill">üçÉ Yaprak: <span id="leaves">0</span></div>
      </div>

      <div class="koalas" id="koalas">üê®</div>
      <div class="toast" id="toast"></div>
    </div>

    <!-- GAME -->
    <div id="game" class="hidden">
      <div class="topbar">
        <div class="left">
          <div class="pill">‚≠ê <span id="gStars">0</span></div>
          <div class="pill">üçÉ <span id="gLeaves">0</span></div>
          <div class="pill">Soru <span id="gIndex">1</span>/<span id="gTotal">10</span></div>
        </div>
        <button class="btn ghost" style="width:auto; margin:0; padding:10px 12px;" onclick="backHome()">Geri</button>
      </div>

      <div class="qcard" id="qcard">
        <p class="hint" id="modeText">Hƒ±z Turu</p>
        <div class="q" id="question">2 √ó 2 = ?</div>
        <div class="ans" id="answerBox">&nbsp;</div>

        <div class="keypad">
          <button class="key" onclick="tap('1')">1</button>
          <button class="key" onclick="tap('2')">2</button>
          <button class="key" onclick="tap('3')">3</button>
          <button class="key" onclick="tap('4')">4</button>
          <button class="key" onclick="tap('5')">5</button>
          <button class="key" onclick="tap('6')">6</button>
          <button class="key" onclick="tap('7')">7</button>
          <button class="key" onclick="tap('8')">8</button>
          <button class="key" onclick="tap('9')">9</button>

          <button class="key alt" onclick="clearAns()">Sil</button>
          <button class="key" onclick="tap('0')">0</button>
          <button class="key alt" onclick="ok()">OK</button>
        </div>

        <div class="toast" id="gToast"></div>
      </div>
    </div>

    <!-- FOREST -->
    <div class="card hidden" id="forest">
      <h1>Orman</h1>
      <p class="sub">≈ûimdilik basit. Birazdan aƒüa√ßlarƒ± da ekleyeceƒüiz.</p>

      <div class="row">
        <div class="pill">Aƒüa√ß: <span id="fTrees">1</span></div>
        <div class="pill">Koala: <span id="fKoalas">1</span></div>
      </div>

      <div class="koalas" id="fKoalaIcons">üê®</div>
      <div class="toast" id="fToast"></div>

      <button class="btn ghost" onclick="backHome()">Geri</button>
    </div>

  </div>

  <script>
    // ====== STATE ======
    // v3: eski cache karƒ±≈ümasƒ±n diye key deƒüi≈ütirdim
    const SKEY="koala_state_v3";
    const state = JSON.parse(localStorage.getItem(SKEY) || '{"stars":0,"leaves":0,"koalas":1,"trees":1}');
    function save(){ localStorage.setItem(SKEY, JSON.stringify(state)); }

    function toast(msg){ document.getElementById("toast").textContent = msg; }
    function gToast(msg){ document.getElementById("gToast").textContent = msg; }
    function fToast(msg){ document.getElementById("fToast").textContent = msg; }

    function renderHome(){
      document.getElementById("stars").textContent = state.stars;
      document.getElementById("leaves").textContent = state.leaves;
      document.getElementById("koalas").textContent = "üê®".repeat(Math.min(12, state.koalas));
    }

    function renderGameTop(){
      document.getElementById("gStars").textContent = state.stars;
      document.getElementById("gLeaves").textContent = state.leaves;
      document.getElementById("gIndex").textContent = game.index + 1;
      document.getElementById("gTotal").textContent = game.total;
    }

    function renderForest(){
      document.getElementById("fTrees").textContent = state.trees;
      document.getElementById("fKoalas").textContent = state.koalas;
      document.getElementById("fKoalaIcons").textContent = "üê®".repeat(Math.min(16, state.koalas));
    }

    function show(id){
      document.getElementById("home").classList.add("hidden");
      document.getElementById("game").classList.add("hidden");
      document.getElementById("forest").classList.add("hidden");
      document.getElementById(id).classList.remove("hidden");
    }

    function backHome(){
      show("home");
      renderHome();
      toast("");
    }

    function showForest(){
      show("forest");
      renderForest();
      fToast("Orman burada. Yakƒ±nda aƒüa√ßlar √ßoƒüalacak üå≥");
    }

    // ====== GAME ENGINE (MVP) ======
    const game = { mode:"speed", total:10, index:0, a:2, b:2, startMs:0, typed:"" };

    function rand2to9(){ return Math.floor(Math.random()*8)+2; }

    function configForMode(mode){
      if(mode==="speed") return { total: 12, label: "Hƒ±z Turu" };
      if(mode==="target") return { total: 10, label: "Hedef Turu" };
      return { total: 20, label: "Boss" };
    }

    function startMode(mode){
      const cfg = configForMode(mode);
      game.mode = mode;
      game.total = cfg.total;
      game.index = 0;

      document.getElementById("modeText").textContent = cfg.label;
      show("game");
      nextQuestion();
    }

    function nextQuestion(){
      game.typed = "";
      document.getElementById("answerBox").innerHTML = "&nbsp;";
      gToast("");

      game.a = rand2to9();
      game.b = rand2to9();
      document.getElementById("question").textContent = `${game.a} √ó ${game.b} = ?`;
      game.startMs = Date.now();

      renderGameTop();
    }

    function tap(d){
      if(game.typed.length >= 3) return;
      game.typed += d;
      document.getElementById("answerBox").textContent = game.typed;
    }

    function clearAns(){
      game.typed = "";
      document.getElementById("answerBox").innerHTML = "&nbsp;";
    }

    function leavesFor(ms){
      if(ms < 2500) return 2;
      if(ms < 4000) return 1;
      return 0;
    }

    function applyKoalaBirth(){
      const shouldKoalas = 1 + Math.floor(state.stars/15);
      if(state.koalas < shouldKoalas){
        state.koalas = shouldKoalas;
        const shouldTrees = Math.max(1, Math.ceil(state.koalas/4));
        if(state.trees < shouldTrees){
          state.trees = shouldTrees;
          return "tree";
        }
        return "koala";
      }
      return "none";
    }

    function ok(){
      const ans = Number(game.typed);
      const correctAns = game.a * game.b;
      const dt = Date.now() - game.startMs;

      if(Number.isNaN(ans)){
        gToast("Bir sayƒ± yaz üôÇ");
        return;
      }

      let msg = "";
      if(ans === correctAns){
        state.stars += 1;
        const l = leavesFor(dt);
        state.leaves += l;
        msg = (l===2) ? "√áok hƒ±zlƒ±! üçÉüçÉ" : (l===1) ? "Hƒ±zlƒ±! üçÉ" : "Doƒüru! üê®";
      } else {
        msg = `Cevap: ${correctAns}`;
      }

      const birth = applyKoalaBirth();
      if(birth === "tree") msg = "Orman b√ºy√ºd√º! Yeni aƒüa√ß üå≥‚ú®";
      else if(birth === "koala") msg = "Yeni koala doƒüdu! üéâ";

      save();
      renderGameTop();
      gToast(msg);

      const qc = document.getElementById("qcard");
      qc.classList.remove("pulse"); void qc.offsetWidth; qc.classList.add("pulse");

      game.index += 1;
      if(game.index >= game.total){
        setTimeout(() => { backHome(); toast("Tur bitti. Orman seni sevdi üåø"); }, 450);
      } else {
        setTimeout(() => { nextQuestion(); }, 450);
      }
    }

    // ====== OFFLINE (service worker) ======
    // v=3 cache kƒ±rmak i√ßin
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("sw.js?v=3");
    }

    renderHome();
    toast("");
  </script>
</body>
</html>
