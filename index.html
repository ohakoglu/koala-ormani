<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#EAF6FF" />
  <link rel="manifest" href="manifest.json" />
  <title>Koala Ormanƒ±</title>
  <style>
    body{margin:0;font-family:-apple-system,system-ui,Arial;background:#EAF6FF;color:#0f172a}
    .wrap{max-width:640px;margin:0 auto;padding:16px}
    .card{background:#fff;border-radius:18px;padding:16px;box-shadow:0 10px 28px rgba(0,0,0,.08)}
    h1{font-size:22px;margin:0 0 10px}
    .sub{opacity:.78;margin:0 0 14px;font-weight:800}
    .ver{display:inline-block;font-size:12px;font-weight:950;padding:6px 10px;border-radius:999px;background:#EAF2FF;color:#1F6FEB}

    .btn{width:100%;border:0;border-radius:14px;padding:14px;margin:10px 0;font-size:16px;font-weight:950;background:#1F6FEB;color:#fff}
    .btn.secondary{background:#EAF2FF;color:#1F6FEB}
    .btn.ghost{background:#F1F5F9;color:#0f172a}

    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    .pill{background:#F1F5F9;padding:10px 12px;border-radius:999px;font-weight:950;border:1px solid rgba(15,23,42,.06)}
    .toast{margin-top:10px;font-weight:950;min-height:24px}
    .hidden{display:none}

    /* GAME */
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .topbar .left{display:flex;gap:10px;flex-wrap:wrap}
    .qcard{background:#fff;border-radius:18px;padding:16px;box-shadow:0 10px 28px rgba(0,0,0,.08);margin-top:12px}
    .q{font-size:40px;font-weight:1000;text-align:center;margin:6px 0 8px}
    .hint{text-align:center;opacity:.75;margin:0 0 10px;font-weight:950}
    .ans{font-size:28px;font-weight:1000;text-align:center;background:#F8FAFC;border-radius:14px;padding:12px;min-height:38px;border:1px solid rgba(15,23,42,.06)}

    .keypad{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
    .key{
      width:calc(33.333% - 6.666px);
      border:1px solid rgba(15,23,42,.10);
      border-radius:14px;padding:14px 0;font-size:18px;font-weight:1000;background:#fff
    }
    .key.alt{background:#EAF2FF;color:#1F6FEB;border-color:rgba(31,111,235,.25)}

    /* Micro animations */
    .pulse{animation:pulse .5s ease-in-out 2}
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.03)}100%{transform:scale(1)}}

    .wave{animation:wave .6s ease-in-out 1}
    @keyframes wave{0%{transform:translateY(0)}40%{transform:translateY(-6px)}100%{transform:translateY(0)}}

    .pop{animation:pop .45s ease-out 1}
    @keyframes pop{0%{transform:scale(.75);opacity:.2}100%{transform:scale(1);opacity:1}}

    .bounce{animation:bounce .75s ease-in-out 2}
    @keyframes bounce{0%{transform:translateY(0)}50%{transform:translateY(-10px)}100%{transform:translateY(0)}}

    /* KOALA CARDS (now: clear + cute + named) */
    .koalaStrip{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
    .kcard{
      --sz: 96px;
      width:var(--sz);height:var(--sz);
      border-radius:22px;
      position:relative;
      overflow:hidden;
      border:2px solid rgba(15,23,42,.12);
      box-shadow:0 14px 30px rgba(0,0,0,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.55), rgba(255,255,255,.15));
      display:flex;align-items:center;justify-content:center;
      user-select:none;
    }
    .kinner{
      position:absolute; inset:10px;
      border-radius:18px;
      background: rgba(255,255,255,.32);
      border:1px solid rgba(255,255,255,.55);
      backdrop-filter: blur(1px);
    }
    .kname{
      position:absolute; left:10px; top:8px;
      font-size:12px; font-weight:1000;
      padding:4px 8px; border-radius:999px;
      background: rgba(255,255,255,.72);
      border:1px solid rgba(15,23,42,.10);
      max-width: calc(100% - 20px);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .kstage{
      position:absolute; left:10px; bottom:10px;
      font-size:12px; font-weight:1000;
      padding:4px 8px; border-radius:999px;
      background: rgba(255,255,255,.72);
      border:1px solid rgba(15,23,42,.10);
    }
    .kacc{
      position:absolute; right:10px; bottom:10px;
      font-size:18px;
      filter: drop-shadow(0 2px 2px rgba(0,0,0,.18));
    }

    /* big cards in forest */
    .slot{height:110px;border-radius:22px;background:#F8FAFC;display:flex;align-items:center;justify-content:center;border:1px dashed rgba(15,23,42,.16)}
    .slot .kcard{ --sz: 104px; }

    /* FOREST */
    .forestGrid{display:flex;flex-direction:column;gap:12px;margin-top:12px}
    .tree{background:linear-gradient(180deg, rgba(123,228,149,.25), rgba(255,255,255,.98));
      border-radius:18px;padding:12px;box-shadow:0 10px 28px rgba(0,0,0,.08);border:1px solid rgba(15,23,42,.06)}
    .treeHead{display:flex;justify-content:space-between;align-items:center;font-weight:1000;margin-bottom:10px}
    .slots{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}

    /* OVERLAY */
    #overlay{
      position:fixed;inset:0;background:rgba(0,0,0,.52);
      display:none;align-items:center;justify-content:center;z-index:9999;padding:18px
    }
    #overlayBox{
      width:min(640px,100%);
      background:#fff;padding:18px;border-radius:20px;
      box-shadow:0 18px 80px rgba(0,0,0,.30);
      text-align:center;position:relative;overflow:hidden
    }
    #overlayBox h2{margin:0 0 6px;font-size:18px}
    #overlayBox p{margin:0 0 12px;opacity:.88;font-weight:950}
    .spark{
      position:absolute; inset:-40px;
      background:
        radial-gradient(circle at 14% 25%, rgba(255,212,122,.65) 0 7px, transparent 8px),
        radial-gradient(circle at 72% 30%, rgba(122,214,161,.65) 0 7px, transparent 8px),
        radial-gradient(circle at 40% 76%, rgba(200,185,255,.65) 0 7px, transparent 8px),
        radial-gradient(circle at 86% 68%, rgba(234,246,255,.98) 0 7px, transparent 8px);
      opacity:.95; animation: floaty 2.1s ease-in-out infinite; pointer-events:none;
    }
    @keyframes floaty { 0%{ transform: translateY(0);} 50%{ transform: translateY(10px);} 100%{ transform: translateY(0);} }

    .ovRow{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin:10px 0 12px}

    /* Growth animation (what the kid will "see") */
    .growWrap{display:flex;justify-content:center;align-items:center;margin:12px 0 6px}
    .growAnim{transform:scale(.55);opacity:.2;animation:grow 700ms ease-out forwards}
    @keyframes grow { 0%{transform:scale(.55);opacity:.2} 70%{transform:scale(1.08);opacity:1} 100%{transform:scale(1);opacity:1} }

    /* small helper */
    .tiny{font-size:12px;opacity:.72;font-weight:900;margin-top:6px}
  </style>
</head>
<body>
  <div class="wrap">

    <div class="card" id="home">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
        <h1 style="margin:0;">Peri ve ƒ∞pek‚Äôin Koala Ormanƒ±</h1>
        <span class="ver">v12</span>
      </div>

      <p class="sub">Bug√ºn 5 dakika. √úz√ºlmek yok. Koalalar b√ºy√ºr.</p>

      <button class="btn" onclick="startMode('speed')">Hƒ±z Turu</button>
      <button class="btn" onclick="startMode('target')">Hedef Turu</button>
      <button class="btn" onclick="startMode('boss')">Boss</button>

      <button class="btn secondary" onclick="showForest()">Ormana Bak üå≥</button>

      <div class="row">
        <div class="pill">‚≠ê <span id="stars">0</span></div>
        <div class="pill">üçÉ <span id="leaves">0</span></div>
        <div class="pill">üå≥ <span id="trees">1</span></div>
        <div class="pill">‚ú® XP: <span id="xp">0</span></div>
      </div>

      <div class="koalaStrip" id="homeKoalas"></div>
      <div class="toast" id="toast"></div>
      <div class="tiny">Koalalar artƒ±k isimli. B√ºy√ºme olayƒ± ‚Äúk√º√ß√ºkten b√ºy√ºƒüe‚Äù animasyonla.</div>
    </div>

    <div id="game" class="hidden">
      <div class="topbar">
        <div class="left">
          <div class="pill">‚≠ê <span id="gStars">0</span></div>
          <div class="pill">üçÉ <span id="gLeaves">0</span></div>
          <div class="pill">‚ú® <span id="gXp">0</span></div>
          <div class="pill"><span id="gIndex">1</span>/<span id="gTotal">10</span></div>
        </div>
        <button class="btn ghost" style="width:auto;margin:0;padding:10px 12px;" onclick="backHome()">Geri</button>
      </div>

      <div class="qcard" id="qcard">
        <p class="hint" id="modeText">Hƒ±z Turu</p>
        <div class="q" id="question">2 √ó 2 = ?</div>
        <div class="ans" id="answerBox">&nbsp;</div>

        <div class="keypad">
          <button class="key" onclick="tap('1')">1</button>
          <button class="key" onclick="tap('2')">2</button>
          <button class="key" onclick="tap('3')">3</button>
          <button class="key" onclick="tap('4')">4</button>
          <button class="key" onclick="tap('5')">5</button>
          <button class="key" onclick="tap('6')">6</button>
          <button class="key" onclick="tap('7')">7</button>
          <button class="key" onclick="tap('8')">8</button>
          <button class="key" onclick="tap('9')">9</button>
          <button class="key alt" onclick="clearAns()">Sil</button>
          <button class="key" onclick="tap('0')">0</button>
          <button class="key alt" onclick="ok()">OK</button>
        </div>

        <div class="toast" id="gToast"></div>
      </div>
    </div>

    <div class="card hidden" id="forest">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
        <h1 style="margin:0;">Orman</h1>
        <span class="ver">v12</span>
      </div>

      <p class="sub">Yeni aƒüa√ß a√ßƒ±lƒ±nca ‚Äúpop‚Äù olur. Koalalar isimleriyle yuvalara yerle≈üir.</p>

      <div class="row">
        <div class="pill">üå≥ <span id="fTrees">1</span></div>
        <div class="pill">üê® <span id="fKoalas">1</span></div>
      </div>

      <div class="forestGrid" id="forestGrid"></div>

      <div class="toast" id="fToast"></div>
      <button class="btn ghost" onclick="backHome()">Geri</button>
    </div>

  </div>

  <div id="overlay">
    <div id="overlayBox">
      <div class="spark"></div>
      <h2 id="ovTitle">üéâ</h2>
      <p id="ovText">...</p>

      <div class="growWrap" id="growWrap" style="display:none;">
        <div class="growAnim" id="growAnim"></div>
      </div>

      <div class="ovRow" id="ovRow"></div>
      <button class="btn" onclick="closeOverlay()">Tamam</button>
      <div class="tiny" id="ovTiny"></div>
    </div>
  </div>

<script>
/* ========= STATE ========= */
const SKEY="koala_state_v12";

const PALETTES=["#C8B9FF","#BFE8C6","#A7D8FF","#FFD6E7","#D3D8E6","#FFE7B0","#B7F0FF","#D9FFE1"];
const ACCESSORIES=["","üåø","üå∏","üß£","‚≠ê","üëë"];

// ‚Äúbaƒü kurduran‚Äù kƒ±sa isimler (√ßocuk dili)
const NAMES = [
  "Mƒ±rmƒ±r","Pofuduk","Bulut","Kƒ±tƒ±r","Minno≈ü","Fƒ±stƒ±k","Mavi≈ü","√áƒ±tƒ±rtƒ±","Tombik","≈ûeker",
  "Pamuk","Pƒ±tƒ±rcƒ±k","Kuki","Zƒ±pzƒ±p","Bƒ±cƒ±r","Pati","Lokum","Bal","Tar√ßƒ±n","Boncuk",
  "G√ºm√º≈ü","√áakƒ±l","Misket","K√∂p√ºk","Badem","√áilek","Duman","Fƒ±ndƒ±k","Karamel","S√ºtla√ß"
];

const RARE=[
  {name:"Z√ºmr√ºt Tilki", face:"ü¶ä", bg:"#BFE8C6"},
  {name:"Ay Bayku≈üu", face:"ü¶â", bg:"#A7D8FF"},
  {name:"Ay I≈üƒ±ƒüƒ± Panda", face:"üêº", bg:"#D3D8E6"}
];

function rng(seed){ let x=Math.sin(seed)*10000; return x-Math.floor(x); }

function stageName(lvl){
  // √áocuƒüun anlayacaƒüƒ± net isimler
  if(lvl===1) return "Minik";
  if(lvl===2) return "B√ºy√ºyor";
  if(lvl===3) return "Kocaman";
  return "Bilge";
}

function pickName(){
  // Aynƒ± isim olursa da ‚Äúolsun‚Äù, √ßocuklar takmƒ±yor. Ama √ßok tekrarƒ± azaltalƒ±m.
  const i = Math.floor(Math.random()*NAMES.length);
  return NAMES[i];
}

function makeKoala(seed){
  const p=Math.floor(rng(seed)*PALETTES.length);
  const a=Math.floor(rng(seed*7.1)*ACCESSORIES.length);
  const e=1+Math.floor(rng(seed*11.7)*3);
  return {
    kind:"koala",
    id:String(seed)+"_"+Math.floor(rng(seed*3.3)*100000),
    palette:p, accessory:a, eyes:e,
    lvl:1,
    name: pickName()
  };
}

function makeRare(seed){
  const r=RARE[Math.floor(rng(seed*9.3)*RARE.length)];
  return {kind:"rare", id:"r_"+String(seed)+"_"+Math.floor(rng(seed*5.5)*100000), name:r.name, face:r.face, bg:r.bg, lvl:1};
}

function loadState(){
  try{
    const raw=localStorage.getItem(SKEY);
    if(raw) return JSON.parse(raw);
  }catch{}
  return {
    stars:0, leaves:0,
    xp:0,
    koalas:[makeKoala(Date.now())],
    lastTreeEvent:false
  };
}

const state=loadState();
if(!Array.isArray(state.koalas) || state.koalas.length===0) state.koalas=[makeKoala(Date.now())];
if(typeof state.stars!=="number") state.stars=0;
if(typeof state.leaves!=="number") state.leaves=0;
if(typeof state.xp!=="number") state.xp=0;
if(typeof state.lastTreeEvent!=="boolean") state.lastTreeEvent=false;

// migration: eski koalalara isim ekle
for(const k of state.koalas){
  if(k.kind==="koala" && !k.name) k.name = pickName();
  if(!k.lvl) k.lvl = 1;
}

function treesNow(){ return Math.max(1, Math.ceil(state.koalas.length/4)); }
function save(){ localStorage.setItem(SKEY, JSON.stringify(state)); }
function $(id){ return document.getElementById(id); }

function show(id){
  $("home").classList.add("hidden");
  $("game").classList.add("hidden");
  $("forest").classList.add("hidden");
  $(id).classList.remove("hidden");
}

/* ========= KOALA RENDER (cute SVG) ========= */
function koalaSVG(k){
  // lvl -> slightly bigger face, more ‚Äúpresence‚Äù
  const lvl = k.lvl || 1;
  const scale = (lvl===1?1.00:lvl===2?1.06:lvl===3?1.12:1.18);

  // color scheme
  const bg = (k.kind==="rare") ? (k.bg || "#EAF2FF") : (PALETTES[k.palette] || PALETTES[0]);
  const ear = "rgba(15,23,42,.18)";
  const line = "rgba(15,23,42,.22)";

  if(k.kind==="rare"){
    // rare animal: big emoji in center
    return `
      <div style="position:absolute;inset:0;background:${bg};"></div>
      <div class="kinner"></div>
      <div style="position:relative;z-index:2;font-size:40px;transform:translateY(2px)">${k.face}</div>
    `;
  }

  // eyes variations
  const e = k.eyes || 1;
  const eyes = (e===1) ? "‚Ä¢  ‚Ä¢" : (e===2) ? "Àò  Àò" : "‚Ä¢  ‚©ä";

  return `
    <div style="position:absolute;inset:0;background:${bg};"></div>
    <div class="kinner"></div>

    <svg viewBox="0 0 100 100" width="78" height="78" style="position:relative;z-index:2;transform:scale(${scale});">
      <!-- ears -->
      <g>
        <circle cx="28" cy="28" r="16" fill="rgba(255,255,255,.28)" stroke="${line}" stroke-width="2"/>
        <circle cx="72" cy="28" r="16" fill="rgba(255,255,255,.28)" stroke="${line}" stroke-width="2"/>
        <circle cx="28" cy="28" r="9" fill="rgba(15,23,42,.10)"/>
        <circle cx="72" cy="28" r="9" fill="rgba(15,23,42,.10)"/>
      </g>

      <!-- head -->
      <g>
        <ellipse cx="50" cy="54" rx="30" ry="28" fill="rgba(255,255,255,.22)" stroke="${line}" stroke-width="2"/>
        <!-- cheeks -->
        <circle cx="34" cy="60" r="6" fill="rgba(255,120,170,.18)"/>
        <circle cx="66" cy="60" r="6" fill="rgba(255,120,170,.18)"/>

        <!-- eyes text -->
        <text x="50" y="58" text-anchor="middle" font-size="18" font-weight="900" fill="rgba(15,23,42,.82)" font-family="-apple-system,system-ui,Arial">
          ${eyes}
        </text>

        <!-- nose -->
        <path d="M50 62 C44 62 42 67 42 70 C42 75 46 79 50 79 C54 79 58 75 58 70 C58 67 56 62 50 62 Z"
              fill="rgba(15,23,42,.22)"/>
        <circle cx="47" cy="67" r="1.6" fill="rgba(255,255,255,.45)"/>
        <circle cx="53" cy="67" r="1.6" fill="rgba(255,255,255,.45)"/>
      </g>
    </svg>
  `;
}

function koalaCard(k, big=false){
  const el=document.createElement("div");
  el.className="kcard";
  el.style.setProperty("--sz", big ? "104px" : "96px");

  const name=document.createElement("div");
  name.className="kname";
  name.textContent = k.kind==="rare" ? k.name : (k.name || "Koala");

  const stage=document.createElement("div");
  stage.className="kstage";
  stage.textContent = k.kind==="rare" ? "Misafir" : stageName(k.lvl||1);

  const acc=document.createElement("div");
  acc.className="kacc";
  acc.textContent = (k.kind==="rare") ? "‚ú®" : (ACCESSORIES[k.accessory] || "");

  el.innerHTML = koalaSVG(k);
  el.appendChild(name);
  el.appendChild(stage);
  if(acc.textContent) el.appendChild(acc);

  return el;
}

/* ========= HOME / FOREST ========= */
function renderHome(){
  $("stars").textContent=state.stars;
  $("leaves").textContent=state.leaves;
  $("trees").textContent=treesNow();
  $("xp").textContent=state.xp;

  const strip=$("homeKoalas");
  strip.innerHTML="";
  for(let i=0;i<Math.min(8, state.koalas.length); i++){
    strip.appendChild(koalaCard(state.koalas[i], false));
  }
}

function renderForest(){
  const trees=treesNow();
  $("fTrees").textContent=trees;
  $("fKoalas").textContent=state.koalas.length;

  const grid=$("forestGrid");
  grid.innerHTML="";

  const shouldAnimateNewTree = state.lastTreeEvent === true;

  for(let t=0;t<trees;t++){
    const tree=document.createElement("div");
    tree.className="tree";
    if(shouldAnimateNewTree && t===trees-1) tree.classList.add("pop");
    else if(shouldAnimateNewTree) tree.classList.add("wave");

    const head=document.createElement("div");
    head.className="treeHead";
    head.innerHTML=`<span>Aƒüa√ß ${t+1}</span><span>${t*4+1}‚Äì${Math.min((t+1)*4, state.koalas.length)}</span>`;
    tree.appendChild(head);

    const slots=document.createElement("div");
    slots.className="slots";
    for(let s=0;s<4;s++){
      const idx=t*4+s;
      const slot=document.createElement("div");
      slot.className="slot";
      if(state.koalas[idx]) slot.appendChild(koalaCard(state.koalas[idx], true));
      slots.appendChild(slot);
    }
    tree.appendChild(slots);
    grid.appendChild(tree);
  }

  if(state.lastTreeEvent){
    state.lastTreeEvent=false;
    save();
  }
}

/* ========= OVERLAY ========= */
function openOverlay({title, text, cards=null, growCard=null, tiny=""}){
  $("ovTitle").textContent=title;
  $("ovText").textContent=text;
  $("ovTiny").textContent=tiny || "";

  // growth panel
  const growWrap = $("growWrap");
  const growAnim = $("growAnim");
  if(growCard){
    growWrap.style.display="flex";
    growAnim.innerHTML="";
    const c = koalaCard(growCard, true);
    c.classList.add("growAnim");
    growAnim.appendChild(c);
  } else {
    growWrap.style.display="none";
    growAnim.innerHTML="";
  }

  const row=$("ovRow");
  row.innerHTML="";
  if(cards && cards.length){
    for(const c of cards){
      const el = koalaCard(c, true);
      el.classList.add("bounce");
      row.appendChild(el);
    }
  } else {
    const start=Math.max(0, state.koalas.length-4);
    for(let i=start;i<state.koalas.length;i++){
      const el = koalaCard(state.koalas[i], true);
      row.appendChild(el);
    }
  }

  $("overlay").style.display="flex";
}
window.closeOverlay=function(){ $("overlay").style.display="none"; };

/* ========= XP + LEVEL UP (visible) ========= */
const XP_PER_LEVEL = 18;  // morale-friendly
const MAX_LVL = 4;

function levelUpOne(){
  // choose the oldest "smallest" (lowest lvl) koala that is not rare
  let idx=-1, best=999;
  for(let i=0;i<state.koalas.length;i++){
    const k=state.koalas[i];
    if(k.kind!=="koala") continue;
    const lvl=(k.lvl||1);
    if(lvl < best){ best=lvl; idx=i; }
  }
  if(idx>=0){
    const k=state.koalas[idx];
    if((k.lvl||1) < MAX_LVL){
      k.lvl = (k.lvl||1) + 1;
      return k;
    }
  }
  return null;
}

function addXP(amount){
  let leveledKoala=null;
  state.xp += amount;
  while(state.xp >= XP_PER_LEVEL){
    state.xp -= XP_PER_LEVEL;
    const k = levelUpOne();
    if(k) leveledKoala = k;
  }
  return leveledKoala;
}

/* ========= BIRTHS (15 stars) + RARE (%2) ========= */
function ensureBirths(){
  const should = 1 + Math.floor(state.stars/15);
  let born=null, any=0;
  const oldTrees=treesNow();

  while(state.koalas.length < should){
    const seed=Date.now() + state.koalas.length*999 + Math.floor(Math.random()*9999);
    const rare = Math.random() < 0.02;
    const baby = rare ? makeRare(seed) : makeKoala(seed);
    state.koalas.push(baby);
    born=baby; any++;
  }

  const newTrees=treesNow();
  return {any, born, treeOpened: (newTrees > oldTrees)};
}

/* ========= GAME ========= */
const game={ mode:"speed", total:10, index:0, a:2, b:2, typed:"", startMs:0 };

function cfg(mode){
  if(mode==="speed") return {total:12, label:"Hƒ±z Turu"};
  if(mode==="target") return {total:10, label:"Hedef Turu"};
  return {total:20, label:"Boss"};
}
function leavesFor(ms){ return ms<2500?2:ms<4000?1:0; }
function rand2to9(){ return Math.floor(Math.random()*8)+2; }

function nextQ(){
  game.typed="";
  $("answerBox").innerHTML="&nbsp;";
  $("gToast").textContent="";

  game.a=rand2to9();
  game.b=rand2to9();
  $("question").textContent=`${game.a} √ó ${game.b} = ?`;
  game.startMs=Date.now();

  $("gStars").textContent=state.stars;
  $("gLeaves").textContent=state.leaves;
  $("gXp").textContent=state.xp;
  $("gIndex").textContent=game.index+1;
  $("gTotal").textContent=game.total;
}

/* ========= GLOBAL BUTTONS ========= */
window.startMode=function(mode){
  const c=cfg(mode);
  game.mode=mode;
  game.total=c.total;
  game.index=0;
  $("modeText").textContent=c.label;
  show("game");
  nextQ();
};

window.backHome=function(){
  show("home");
  renderHome();
  $("toast").textContent="";
};

window.showForest=function(){
  show("forest");
  renderForest();
  $("fToast").textContent="Orman burada üå≥";
};

window.tap=function(d){
  if(game.typed.length>=3) return;
  game.typed+=d;
  $("answerBox").textContent=game.typed;
};

window.clearAns=function(){
  game.typed="";
  $("answerBox").innerHTML="&nbsp;";
};

window.ok=function(){
  const ans=Number(game.typed);
  if(Number.isNaN(ans)){ $("gToast").textContent="Bir sayƒ± yaz üôÇ"; return; }

  const correct=game.a*game.b;
  const dt=Date.now()-game.startMs;

  let xpGain=0;
  let didCorrect=false;

  if(ans===correct){
    didCorrect=true;
    state.stars += 1;
    const l=leavesFor(dt);
    state.leaves += l;

    xpGain = 2 + (l===2 ? 2 : l===1 ? 1 : 0);
    const msg = (l===2)?"√áok hƒ±zlƒ±! üçÉüçÉ":(l===1)?"Hƒ±zlƒ±! üçÉ":"Doƒüru! üê®";
    $("gToast").textContent = msg + `  +${xpGain}XP`;
  }else{
    $("gToast").textContent = `Cevap: ${correct}`;
  }

  // XP -> possible level up (visible)
  let leveledKoala=null;
  if(xpGain>0) leveledKoala = addXP(xpGain);

  // births / tree
  const births=ensureBirths();
  if(births.treeOpened) state.lastTreeEvent=true;

  save();

  $("gStars").textContent=state.stars;
  $("gLeaves").textContent=state.leaves;
  $("gXp").textContent=state.xp;

  const qc=$("qcard");
  qc.classList.remove("pulse"); void qc.offsetWidth; qc.classList.add("pulse");

  // Overlay priority: new tree > rare birth > normal birth > level up
  if(births.any>0){
    if(births.treeOpened){
      openOverlay({
        title:"Yeni aƒüa√ß a√ßƒ±ldƒ±! üå≥‚ú®",
        text:"Orman b√ºy√ºd√º! Yeni yuvalar hazƒ±r.",
        cards: state.koalas.slice(-4),
        tiny:"ƒ∞stersen Orman‚Äôa bak üòâ"
      });
    }else if(births.born && births.born.kind==="rare"){
      openOverlay({
        title:"Nadir bir misafir geldi! ‚ú®",
        text: births.born.name + " ormana uƒüradƒ±!",
        cards: [births.born],
        tiny:"Misafirler √ßok nadir gelir."
      });
    }else{
      openOverlay({
        title:"Yeni koala doƒüdu! üéâ",
        text:"Ho≈ü geldin " + (births.born.name || "Minik") + "!",
        cards: [births.born],
        tiny:"Koalalar 15 yƒ±ldƒ±zda bir doƒüar."
      });
    }
  } else if(leveledKoala){
    // growth overlay with visible grow animation
    openOverlay({
      title:"Koala b√ºy√ºd√º! ‚ú®",
      text: (leveledKoala.name || "Koala") + " artƒ±k: " + stageName(leveledKoala.lvl),
      growCard: leveledKoala,
      tiny:"Bu sefer ger√ßekten b√ºy√ºd√ºƒü√ºn√º g√∂rd√ºn üôÇ"
    });
  }

  // keep home updated
  renderHome();

  game.index += 1;
  if(game.index>=game.total){
    setTimeout(()=>{ window.backHome(); $("toast").textContent="Tur bitti üåø"; }, 300);
  }else{
    setTimeout(()=>nextQ(), 300);
  }
};

/* INIT */
renderHome();
$("toast").textContent="Hazƒ±r ‚úÖ";
</script>
</body>
</html>
