<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#EAF6FF" />
  <link rel="manifest" href="manifest.json" />
  <title>Koala Ormanƒ±</title>
  <style>
    body { margin:0; font-family: -apple-system, system-ui, Arial; background:#EAF6FF; color:#0f172a; }
    .wrap { max-width: 520px; margin: 0 auto; padding: 16px; }
    .card { background:#fff; border-radius:16px; padding:16px; box-shadow: 0 6px 20px rgba(0,0,0,.06); }
    h1 { font-size: 22px; margin: 0 0 10px; }
    .sub { opacity:.75; margin: 0 0 14px; font-weight:700; }

    .btn { width:100%; border:0; border-radius:14px; padding:14px; margin:10px 0; font-size:16px; font-weight:900; background:#1F6FEB; color:#fff; }
    .btn.secondary { background:#EAF2FF; color:#1F6FEB; }
    .btn.ghost { background:#F1F5F9; color:#0f172a; }

    .row { display:flex; gap:10px; flex-wrap:wrap; margin-top:14px; }
    .pill { background:#F1F5F9; padding:10px 12px; border-radius:999px; font-weight:900; }
    .toast { margin-top: 10px; font-weight: 900; min-height: 24px; }
    .hidden { display:none; }

    /* k√º√ß√ºk s√ºr√ºm etiketi */
    .ver { display:inline-block; margin-left:10px; font-size:12px; font-weight:900; padding:6px 10px; border-radius:999px; background:#EAF2FF; color:#1F6FEB; }

    /* GAME */
    .topbar { display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .topbar .left { display:flex; gap:10px; flex-wrap:wrap; }
    .qcard { background:#fff; border-radius:16px; padding:16px; box-shadow: 0 6px 20px rgba(0,0,0,.06); margin-top:12px; }
    .q { font-size: 38px; font-weight: 900; text-align:center; margin: 6px 0 8px; }
    .hint { text-align:center; opacity:.75; margin:0 0 10px; font-weight:800; }
    .ans { font-size: 28px; font-weight: 900; text-align:center; background:#F8FAFC; border-radius:14px; padding:12px; min-height: 38px; }

    .keypad { display:flex; flex-wrap:wrap; gap:10px; margin-top:12px; }
    .key { width: calc(33.333% - 6.666px); border:0; border-radius:14px; padding:14px 0; font-size:18px; font-weight:900; background:#fff; }
    .key.alt { background:#EAF2FF; color:#1F6FEB; }

    .pulse { animation: pulse 0.5s ease-in-out 2; }
    @keyframes pulse { 0% { transform: scale(1);} 50% { transform: scale(1.03);} 100% { transform: scale(1);} }

    /* KOALA kartlarƒ± (emoji deƒüil) */
    .koalaStrip { display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px; }
    .koala {
      width: 52px; height: 52px;
      border-radius: 16px;
      position: relative;
      display:flex; align-items:center; justify-content:center;
      box-shadow: 0 6px 16px rgba(0,0,0,.08);
      overflow:hidden;
    }
    .koala::before {
      content:"";
      position:absolute;
      width: 18px; height: 18px; border-radius: 10px;
      left: 6px; top: 6px;
      background: rgba(255,255,255,.35);
      box-shadow: 22px 0 0 rgba(255,255,255,.35);
    }
    .koFace {
      width: 26px; height: 26px; border-radius: 12px;
      background: rgba(255,255,255,.35);
      display:flex; align-items:center; justify-content:center;
      font-size: 16px;
      font-weight: 900;
    }
    .acc { position:absolute; right: 6px; bottom: 6px; font-size: 14px; }
    .lvl { position:absolute; left: 6px; bottom: 6px; font-size: 12px; opacity: .9; }

    /* FOREST */
    .forestWrap { margin-top: 12px; }
    .forestGrid { display:flex; flex-direction:column; gap:12px; }
    .tree {
      background: linear-gradient(180deg, rgba(123,228,149,.25), rgba(255,255,255,.95));
      border-radius: 18px;
      padding: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,.06);
      border: 1px solid rgba(15,23,42,.06);
    }
    .treeHead { display:flex; justify-content:space-between; align-items:center; font-weight: 900; margin-bottom: 10px; }
    .slots { display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; }
    .slot {
      height: 62px;
      border-radius: 16px;
      background: #F8FAFC;
      display:flex; align-items:center; justify-content:center;
      border: 1px dashed rgba(15,23,42,.14);
    }

    /* OVERLAY (toplu sevin√ß) */
    .overlay {
      position: fixed; inset: 0;
      background: rgba(15,23,42,.35);
      display:none;
      align-items:center; justify-content:center;
      padding: 18px;
      z-index: 9999;
    }
    .overlay.show { display:flex; }
    .modal {
      width: min(520px, 100%);
      background: #fff;
      border-radius: 18px;
      padding: 16px;
      box-shadow: 0 16px 50px rgba(0,0,0,.25);
      position: relative;
      overflow:hidden;
    }
    .modal h2 { margin: 0 0 6px; font-size: 18px; }
    .modal p { margin: 0 0 12px; opacity:.8; font-weight:800; }
    .confetti {
      position:absolute; inset:-40px;
      background:
        radial-gradient(circle at 20% 30%, rgba(255,212,122,.55) 0 6px, transparent 7px),
        radial-gradient(circle at 70% 35%, rgba(122,214,161,.55) 0 6px, transparent 7px),
        radial-gradient(circle at 40% 70%, rgba(200,185,255,.55) 0 6px, transparent 7px),
        radial-gradient(circle at 85% 75%, rgba(234,246,255,.9) 0 6px, transparent 7px);
      opacity: .9;
      animation: floaty 2.2s ease-in-out infinite;
      pointer-events:none;
    }
    @keyframes floaty { 0%{ transform: translateY(0);} 50%{ transform: translateY(10px);} 100%{ transform: translateY(0);} }
    .bigKoalaRow { display:flex; gap:12px; flex-wrap:wrap; margin-top: 10px; }
    .bounce { animation: bounce .75s ease-in-out 2; }
    @keyframes bounce { 0%{ transform: translateY(0);} 50%{ transform: translateY(-10px);} 100%{ transform: translateY(0);} }
  </style>
</head>
<body>
  <div class="wrap">

    <!-- HOME -->
    <div class="card" id="home">
      <div style="display:flex; align-items:center; justify-content:space-between;">
        <h1 style="margin:0;">Peri ve ƒ∞pek‚Äôin Koala Ormanƒ± <span class="ver">v5</span></h1>
      </div>

      <p class="sub">Bug√ºn 5 dakika. √úz√ºlmek yok. Koalalar b√ºy√ºr.</p>

      <button class="btn" onclick="startMode('speed')">Hƒ±z Turu</button>
      <button class="btn" onclick="startMode('target')">Hedef Turu</button>
      <button class="btn" onclick="startMode('boss')">Boss</button>

      <button class="btn secondary" onclick="showForest()">Ormana Bak üå≥</button>

      <div class="row">
        <div class="pill">‚≠ê Yƒ±ldƒ±z: <span id="stars">0</span></div>
        <div class="pill">üçÉ Yaprak: <span id="leaves">0</span></div>
        <div class="pill">üå≥ Aƒüa√ß: <span id="trees">1</span></div>
      </div>

      <div class="koalaStrip" id="homeKoalas"></div>
      <div class="toast" id="toast"></div>
    </div>

    <!-- GAME -->
    <div id="game" class="hidden">
      <div class="topbar">
        <div class="left">
          <div class="pill">‚≠ê <span id="gStars">0</span></div>
          <div class="pill">üçÉ <span id="gLeaves">0</span></div>
          <div class="pill">Soru <span id="gIndex">1</span>/<span id="gTotal">10</span></div>
        </div>
        <button class="btn ghost" style="width:auto; margin:0; padding:10px 12px;" onclick="backHome()">Geri</button>
      </div>

      <div class="qcard" id="qcard">
        <p class="hint" id="modeText">Hƒ±z Turu</p>
        <div class="q" id="question">2 √ó 2 = ?</div>
        <div class="ans" id="answerBox">&nbsp;</div>

        <div class="keypad">
          <button class="key" onclick="tap('1')">1</button>
          <button class="key" onclick="tap('2')">2</button>
          <button class="key" onclick="tap('3')">3</button>
          <button class="key" onclick="tap('4')">4</button>
          <button class="key" onclick="tap('5')">5</button>
          <button class="key" onclick="tap('6')">6</button>
          <button class="key" onclick="tap('7')">7</button>
          <button class="key" onclick="tap('8')">8</button>
          <button class="key" onclick="tap('9')">9</button>

          <button class="key alt" onclick="clearAns()">Sil</button>
          <button class="key" onclick="tap('0')">0</button>
          <button class="key alt" onclick="ok()">OK</button>
        </div>

        <div class="toast" id="gToast"></div>
      </div>
    </div>

    <!-- FOREST -->
    <div class="card hidden" id="forest">
      <h1>Orman <span class="ver">aƒüa√ßlƒ±</span></h1>
      <p class="sub">Koalalar aƒüa√ßlara yerle≈üir. Yeni koala doƒüunca orman sevinir.</p>

      <div class="row">
        <div class="pill">üå≥ Aƒüa√ß: <span id="fTrees">1</span></div>
        <div class="pill">üê® Koala: <span id="fKoalas">1</span></div>
      </div>

      <div class="forestWrap">
        <div class="forestGrid" id="forestGrid"></div>
      </div>

      <div class="toast" id="fToast"></div>
      <button class="btn ghost" onclick="backHome()">Geri</button>
    </div>

  </div>

  <!-- OVERLAY -->
  <div class="overlay" id="overlay">
    <div class="modal">
      <div class="confetti"></div>
      <h2 id="ovTitle">Yeni koala doƒüdu!</h2>
      <p id="ovText">Orman seviniyor üéâ</p>
      <div class="bigKoalaRow" id="ovKoalas"></div>
      <button class="btn" onclick="closeOverlay()">Tamam</button>
    </div>
  </div>

  <script>
    // ========= OTOMATƒ∞K CACHE/WORKER TEMƒ∞ZLƒ∞ƒûƒ∞ (1 kere) =========
    // Ama√ß: sen elle Safari cache temizlemek zorunda kalma.
    (async function migrateSWOnce(){
      try{
        const flag = localStorage.getItem("koala_sw_migrated_v5");
        if(flag === "1") return;

        // Eski service worker‚Äôlarƒ± kapat
        if ("serviceWorker" in navigator) {
          const regs = await navigator.serviceWorker.getRegistrations();
          for (const r of regs) await r.unregister();
        }

        // Eski cache‚Äôleri sil
        if (window.caches) {
          const keys = await caches.keys();
          await Promise.all(keys.map(k => caches.delete(k)));
        }

        localStorage.setItem("koala_sw_migrated_v5", "1");

        // Bir kere yenile (yeni dosyalar gelsin)
        location.reload();
      } catch {
        // sorun olursa sessiz ge√ß
      }
    })();

    // ========= STATE (eski s√ºr√ºmlerden ge√ßi≈ü dahil) =========
    const SKEY="koala_state_v5";

    function structuredCloneSafe(obj){ return JSON.parse(JSON.stringify(obj)); }

    const defaultState = {
      stars: 0,
      leaves: 0,
      trees: 1,
      koalas: [ makeKoala(Date.now() % 1000000) ]
    };

    const state = loadState();

    function loadState(){
      // √ñnce yeni key
      const rawNew = localStorage.getItem(SKEY);
      if(rawNew){
        try { return normalize(JSON.parse(rawNew)); } catch {}
      }

      // Eski key‚Äôlerden (v3/v4) ta≈üƒ±maya √ßalƒ±≈ü
      const candidates = ["koala_state_v4","koala_state_v3","koala_state_v2","koala_state_v1"];
      for(const k of candidates){
        const r = localStorage.getItem(k);
        if(!r) continue;
        try{
          const old = JSON.parse(r);
          const converted = convertOld(old);
          localStorage.setItem(SKEY, JSON.stringify(converted));
          return converted;
        } catch {}
      }

      const fresh = structuredCloneSafe(defaultState);
      localStorage.setItem(SKEY, JSON.stringify(fresh));
      return fresh;
    }

    function normalize(s){
      if(typeof s.stars !== "number") s.stars = 0;
      if(typeof s.leaves !== "number") s.leaves = 0;
      if(!Array.isArray(s.koalas)) s.koalas = [makeKoala(12345)];
      s.trees = Math.max(1, Math.ceil(s.koalas.length/4));
      return s;
    }

    function convertOld(old){
      // old: {stars, leaves, koalas:number} veya {stars,leaves,koalas:[...]}
      let stars = Number(old.stars||0);
      let leaves = Number(old.leaves||0);

      let koalasArr = [];
      if(Array.isArray(old.koalas)){
        // zaten obje listesi olabilir
        koalasArr = old.koalas.map(x => (x && x.id) ? x : makeKoala(Date.now()+Math.random()*9999));
      } else {
        const count = Math.max(1, Number(old.koalas||1));
        for(let i=0;i<count;i++) koalasArr.push(makeKoala(Date.now()+i*9999));
      }

      const s = { stars, leaves, koalas: koalasArr, trees: Math.max(1, Math.ceil(koalasArr.length/4)) };
      return normalize(s);
    }

    function save(){
      state.trees = Math.max(1, Math.ceil(state.koalas.length/4));
      localStorage.setItem(SKEY, JSON.stringify(state));
    }

    function toast(msg){ document.getElementById("toast").textContent = msg; }
    function gToast(msg){ document.getElementById("gToast").textContent = msg; }
    function fToast(msg){ document.getElementById("fToast").textContent = msg; }

    // ========= KOALA VARYASYON =========
    function rng(seed){ let x = Math.sin(seed) * 10000; return x - Math.floor(x); }
    const PALETTES = ["#C8B9FF","#BFE8C6","#A7D8FF","#FFD6E7","#D3D8E6","#FFE7B0","#B7F0FF","#D9FFE1"];
    const ACCESSORIES = ["","üåø","üå∏","üß£","‚≠ê","üëë"];

    function makeKoala(seed){
      const pIndex = Math.floor(rng(seed)*PALETTES.length);
      const aIndex = Math.floor(rng(seed*7.1)*ACCESSORIES.length);
      const eyeIndex = 1 + Math.floor(rng(seed*11.7)*3); // 1..3
      return { id: String(seed)+"_"+Math.floor(rng(seed*3.3)*100000), palette:pIndex, accessory:aIndex, eyes:eyeIndex, lvl:1 };
    }
    function koalaEyesChar(eyes){
      if(eyes===1) return "‚Ä¢·¥•‚Ä¢";
      if(eyes===2) return "Àò·¥•Àò";
      return "‚Ä¢‚©ä‚Ä¢";
    }
    function koalaLevelEmoji(lvl){
      if(lvl===1) return "üå±";
      if(lvl===2) return "üåø";
      if(lvl===3) return "üçÉ";
      return "‚ú®";
    }
    function koalaCard(k, big=false){
      const bg = PALETTES[k.palette] || PALETTES[0];
      const acc = ACCESSORIES[k.accessory] || "";
      const size = big ? 62 : 52;

      const el = document.createElement("div");
      el.className = "koala";
      el.style.width = size+"px";
      el.style.height = size+"px";
      el.style.background = bg;

      const face = document.createElement("div");
      face.className = "koFace";
      face.style.fontSize = big ? "18px" : "16px";
      face.textContent = koalaEyesChar(k.eyes);

      const accEl = document.createElement("div");
      accEl.className = "acc";
      accEl.textContent = acc;

      const lvlEl = document.createElement("div");
      lvlEl.className = "lvl";
      lvlEl.textContent = koalaLevelEmoji(k.lvl);

      el.appendChild(face);
      if(acc) el.appendChild(accEl);
      el.appendChild(lvlEl);
      return el;
    }

    // ========= UI =========
    function renderHome(){
      document.getElementById("stars").textContent = state.stars;
      document.getElementById("leaves").textContent = state.leaves;
      document.getElementById("trees").textContent = state.trees;

      const strip = document.getElementById("homeKoalas");
      strip.innerHTML = "";
      for(let i=0;i<Math.min(8, state.koalas.length); i++){
        strip.appendChild(koalaCard(state.koalas[i]));
      }
    }

    function renderGameTop(){
      document.getElementById("gStars").textContent = state.stars;
      document.getElementById("gLeaves").textContent = state.leaves;
      document.getElementById("gIndex").textContent = game.index + 1;
      document.getElementById("gTotal").textContent = game.total;
    }

    function renderForest(){
      document.getElementById("fTrees").textContent = state.trees;
      document.getElementById("fKoalas").textContent = state.koalas.length;

      const grid = document.getElementById("forestGrid");
      grid.innerHTML = "";

      for(let t=0; t<state.trees; t++){
        const tree = document.createElement("div");
        tree.className = "tree";

        const head = document.createElement("div");
        head.className = "treeHead";
        head.innerHTML = `<span>Aƒüa√ß ${t+1}</span><span>${(t*4+1)}‚Äì${Math.min((t+1)*4, state.koalas.length)} / ${state.koalas.length}</span>`;
        tree.appendChild(head);

        const slots = document.createElement("div");
        slots.className = "slots";

        for(let s=0; s<4; s++){
          const idx = t*4 + s;
          const slot = document.createElement("div");
          slot.className = "slot";
          if(state.koalas[idx]) slot.appendChild(koalaCard(state.koalas[idx], true));
          slots.appendChild(slot);
        }

        tree.appendChild(slots);
        grid.appendChild(tree);
      }
    }

    function show(id){
      document.getElementById("home").classList.add("hidden");
      document.getElementById("game").classList.add("hidden");
      document.getElementById("forest").classList.add("hidden");
      document.getElementById(id).classList.remove("hidden");
    }

    function backHome(){
      show("home");
      renderHome();
      toast("");
    }

    function showForest(){
      show("forest");
      renderForest();
      fToast("Orman burada üå≥ Koalalar yuvalarda.");
    }

    // ========= OVERLAY =========
    function openOverlay(type){
      const ov = document.getElementById("overlay");
      const title = document.getElementById("ovTitle");
      const text = document.getElementById("ovText");
      const row = document.getElementById("ovKoalas");
      row.innerHTML = "";

      const last = state.koalas[state.koalas.length-1];
      const list = [last];
      for(let i=Math.max(0, state.koalas.length-4); i<state.koalas.length-1; i++){
        list.push(state.koalas[i]);
      }

      if(type==="tree"){
        title.textContent = "Yeni aƒüa√ß a√ßƒ±ldƒ±! üå≥‚ú®";
        text.textContent = "Orman geni≈üledi. Koalalar topluca sevindi!";
      } else {
        title.textContent = "Yeni koala doƒüdu! üéâ";
        text.textContent = "Orman sevindi. Ho≈ü geldin k√º√ß√ºk koala!";
      }

      list.forEach((k) => {
        const el = koalaCard(k, true);
        el.classList.add("bounce");
        row.appendChild(el);
      });

      ov.classList.add("show");
    }
    function closeOverlay(){ document.getElementById("overlay").classList.remove("show"); }

    // ========= GAME =========
    const game = { mode:"speed", total:10, index:0, a:2, b:2, startMs:0, typed:"" };
    function rand2to9(){ return Math.floor(Math.random()*8)+2; }
    function configForMode(mode){
      if(mode==="speed") return { total: 12, label: "Hƒ±z Turu" };
      if(mode==="target") return { total: 10, label: "Hedef Turu" };
      return { total: 20, label: "Boss" };
    }
    function startMode(mode){
      const cfg = configForMode(mode);
      game.mode = mode;
      game.total = cfg.total;
      game.index = 0;
      document.getElementById("modeText").textContent = cfg.label;
      show("game");
      nextQuestion();
    }
    function nextQuestion(){
      game.typed = "";
      document.getElementById("answerBox").innerHTML = "&nbsp;";
      gToast("");
      game.a = rand2to9();
      game.b = rand2to9();
      document.getElementById("question").textContent = `${game.a} √ó ${game.b} = ?`;
      game.startMs = Date.now();
      renderGameTop();
    }
    function tap(d){
      if(game.typed.length >= 3) return;
      game.typed += d;
      document.getElementById("answerBox").textContent = game.typed;
    }
    function clearAns(){
      game.typed = "";
      document.getElementById("answerBox").innerHTML = "&nbsp;";
    }
    function leavesFor(ms){
      if(ms < 2500) return 2;
      if(ms < 4000) return 1;
      return 0;
    }
    function ensureKoalas(){
      const shouldCount = 1 + Math.floor(state.stars/15);
      let born = 0;
      while(state.koalas.length < shouldCount){
        const seed = Date.now() + state.koalas.length*999 + Math.floor(Math.random()*9999);
        state.koalas.push(makeKoala(seed));
        born++;
      }
      return born;
    }
    function ok(){
      const ans = Number(game.typed);
      const correctAns = game.a * game.b;
      const dt = Date.now() - game.startMs;

      if(Number.isNaN(ans)){ gToast("Bir sayƒ± yaz üôÇ"); return; }

      let msg = "";
      if(ans === correctAns){
        state.stars += 1;
        const l = leavesFor(dt);
        state.leaves += l;
        msg = (l===2) ? "√áok hƒ±zlƒ±! üçÉüçÉ" : (l===1) ? "Hƒ±zlƒ±! üçÉ" : "Doƒüru! üê®";
      } else {
        msg = `Cevap: ${correctAns}`;
      }

      const oldTrees = state.trees;
      const born = ensureKoalas();
      state.trees = Math.max(1, Math.ceil(state.koalas.length/4));
      const newTree = state.trees > oldTrees;

      save();
      renderGameTop();
      gToast(msg);

      const qc = document.getElementById("qcard");
      qc.classList.remove("pulse"); void qc.offsetWidth; qc.classList.add("pulse");

      if(born > 0){
        setTimeout(() => openOverlay(newTree ? "tree" : "koala"), 250);
      }

      game.index += 1;
      if(game.index >= game.total){
        setTimeout(() => { backHome(); toast("Tur bitti. Orman seni sevdi üåø"); }, 450);
      } else {
        setTimeout(() => { nextQuestion(); }, 450);
      }
    }

    // Yeni service worker
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("sw.js?v=5");
    }

    // INIT
    save();
    renderHome();
    toast("");
  </script>
</body>
</html>
